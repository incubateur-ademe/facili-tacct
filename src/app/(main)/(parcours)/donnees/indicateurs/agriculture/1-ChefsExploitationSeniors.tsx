"use client";
import { MicroCircleGrid } from "@/components/charts/MicroDataviz";
import { ExportButtonNouveauParcours } from "@/components/exports/ExportButton";
import { CopyLinkClipboard } from "@/components/interactions/CopyLinkClipboard";
import { Body } from "@/design-system/base/Textes";
import { TableCommuneModel } from "@/lib/postgres/models";
import { PartExploitationSeniorsDynamicText } from "@/lib/textesIndicateurs/agricultureDynamicTexts";
import { IndicatorExportTransformations } from "@/lib/utils/export/environmentalDataExport";
import { useSearchParams } from "next/navigation";
import styles from '../../explorerDonnees.module.scss';

export const PartChefsExploitationSeniors = (props: {
  tableCommune: TableCommuneModel[];
}) => {
  const { tableCommune } = props;
  const searchParams = useSearchParams();
  const code = searchParams.get('code')!;
  const type = searchParams.get('type')!;
  const libelle = searchParams.get('libelle')!;
  const territoireFiltered = type === "commune"
    ? tableCommune.filter(tc => tc.code_geographique === code)
    : type === "epci"
      ? tableCommune.filter(tc => tc.epci === code)
      : type === "pnr"
        ? tableCommune.filter(tc => tc.code_pnr?.includes(code))
        : type === "departement"
          ? tableCommune.filter(tc => tc.departement === code)
          : type === "ept"
            ? tableCommune.filter(tc => tc.ept === libelle)
            : type === "petr"
              ? tableCommune.filter(tc => tc.libelle_petr === libelle)
              : [];

  const meanPartOver55 = type === "commune"
    ? Number(territoireFiltered[0]?.agriculture_part_over_55)
    : territoireFiltered.filter(
      tc => tc.agriculture_part_over_55 !== "NaN"
    ).reduce(
      (acc, curr) => acc + Number(curr.agriculture_part_over_55 || 0), 0
    ) / territoireFiltered.length;
  const exportData = IndicatorExportTransformations.agriculture.chefsExploitationSeniors(territoireFiltered);

  return (
    <>
      <div className={styles.datavizMapContainer}>
        <div
          className={styles.chiffreDynamiqueWrapper}
          style={{ alignItems: 'center', paddingBottom: '2rem', gap: '3rem' }}
        >
          <MicroCircleGrid pourcentage={meanPartOver55} arrondi={1} ariaLabel="Pourcentage de chefs d’exploitation de plus de 55 ans" />
          <div className={styles.text} style={{ paddingRight: "2rem" }}>
            <PartExploitationSeniorsDynamicText
              partOver55={territoireFiltered}
              type={type}
            />
          </div>
        </div>
      </div>
      <div className={styles.sourcesExportWrapper}
        style={{
          borderTop: "1px solid var(--gris-medium)",
          marginLeft: "-2rem"
        }}
      >
        <Body size='sm' style={{ color: "var(--gris-dark)" }}>
          Source : AGRESTE, 2020.
        </Body>
        {
          !meanPartOver55 || meanPartOver55 === 0 ? (
            <CopyLinkClipboard anchor={"Part des chefs d’exploitation séniors"} />
          ) : (
            <ExportButtonNouveauParcours
              data={exportData}
              baseName="part_chefs_exploitation_seniors"
              type={type}
              libelle={libelle}
              code={code}
              sheetName="Chefs d’exploitation séniors"
              anchor="Part des chefs d’exploitation séniors"
            />
          )
        }
      </div>
    </>
  );
};
