import { GraphDataNotFound } from '@/components/graph-data-not-found';
import { Loader } from '@/components/loader';
import { chefsExploitationLegend } from '@/components/maps/legends/datavizLegends';
import { LegendCompColor } from '@/components/maps/legends/legendComp';
import { MapChefsExploitation } from '@/components/maps/mapChefsExploitation';
import { CustomTooltip } from '@/components/utils/CalculTooltip';
import { CommunesIndicateursMapper } from '@/lib/mapper/communes';
import { Agriculture, CarteCommunes } from '@/lib/postgres/models';
import { useSearchParams } from 'next/navigation';
import styles from './agriculture.module.scss';

export const ChefsExploitation = ({
  carteCommunes,
  agriculture
}: {
  carteCommunes: CarteCommunes[];
  agriculture: Agriculture[];
}) => {
  const searchParams = useSearchParams();
  const codgeo = searchParams.get('codgeo');
  const codepci = searchParams.get('codepci')!;
  const commune = codgeo
    ? carteCommunes.find((obj) => obj.code_geographique === codgeo)
    : undefined;

  const carteCommunesEnriched = carteCommunes.map((el) => {
    return {
      ...el,
      chefsExploitation55Ans:
        agriculture.find((item) => item.CODGEO === el.code_geographique)
          ?.part_over_55 ?? NaN
    };
  });

  const communesMap = carteCommunesEnriched.map(CommunesIndicateursMapper);

  const title = (
    <>
      <div>Lorem ipsum : </div>
      <br></br>
      <div>...............</div>
    </>
  );

  return (
    <>
      {carteCommunes ? (
        <div className={styles.container}>
          {agriculture.length ? (
            <>
              <div className="w-2/5">
                <div className={styles.explicationWrapper}>
                  {commune ? (
                    <p style={{ color: '#161616', margin: '0 0 0.5em' }}>
                      Commune
                    </p>
                  ) : (
                    <p style={{ color: '#161616', margin: '0 0 0.5em' }}>
                      EPCI
                    </p>
                  )}
                  <CustomTooltip
                    title={title}
                    texte="D'où vient ce chiffre ?"
                  />
                </div>
                <div className={styles.textWrapper}>
                  <p>
                    Près d’un agriculteur sur deux partira à la retraite d’ici
                    dix ans. Et cette transition arrive à un moment critique :
                    sécheresses, inondations, gels tardifs, pluies excessives…
                    Les événements climatiques extrêmes se multiplient,
                    perturbant semis et récoltes. Les rendements du blé et de
                    l’orge ont fortement chuté, sous l’effet d’une pluviométrie
                    excessive et d’un ensoleillement réduit.
                  </p>
                  <p>
                    Pour s’adapter, les chefs d’exploitation doivent repenser
                    leurs pratiques : diversification des cultures,
                    agroécologie, optimisation de l’eau… Autant de leviers
                    indispensables pour renforcer la résilience du secteur
                    agricole. Mais cette transformation est freinée par le
                    vieillissement des chefs d’exploitation. En plus du manque
                    de transmission, de nombreuses terres agricoles restent
                    bloquées par un phénomène de rétention foncière : leurs
                    propriétaires attendent une revalorisation en zone
                    constructible. En 2022, 21 000 exploitants sont partis à la
                    retraite, mais seuls 14 000 agriculteurs se sont installés.
                    Sans transmission des exploitations, l’agriculture française
                    perdra en capacité d’adaptation, menaçant non seulement la
                    production alimentaire, mais aussi la vitalité des
                    territoires ruraux.
                  </p>
                  <ul>
                    <li>
                      1/3 des exploitants de plus de 60 ans ignorent l’avenir de
                      leur exploitation.
                    </li>
                    <li>
                      50 % des exploitations sont dirigées par un exploitant de
                      55 ans ou plus.
                    </li>
                  </ul>
                  <p>
                    - - - - <br></br>
                    Plan National d'Adaptation au Changement Climatique (PNACC
                    3) :
                  </p>
                  <ul>
                    <li>
                      Développer les connaissances, former et anticiper les
                      conséquences du changement climatique dans le secteur
                      agricole et l’industrie agro-alimentaire (mesure 36).
                    </li>
                    <li>
                      Accompagner les exploitations agricoles, les filières et
                      l’industrie agro-alimentaire face aux aléas climatiques et
                      engager la transition vers des modèles résilients et bas
                      carbone (mesure 37).
                    </li>
                  </ul>
                </div>
              </div>
              <div className="w-3/5">
                <div className={styles.graphWrapper}>
                  <p style={{ padding: '1em', margin: '0' }}>
                    <b>Chefs d'exploitation de plus de 55 ans</b>
                  </p>
                  <MapChefsExploitation carteCommunes={communesMap} />
                  <div
                    className={styles.legend}
                    style={{ width: 'auto', justifyContent: 'center' }}
                  >
                    <LegendCompColor legends={chefsExploitationLegend} />
                  </div>
                  <p style={{ padding: '1em', margin: '0' }}>
                    Source : Agreste - Recensement agricole 2020
                  </p>
                </div>
              </div>
            </>
          ) : (
            <GraphDataNotFound code={codgeo ? codgeo : codepci} />
          )}
        </div>
      ) : (
        <Loader />
      )}
    </>
  );
};
