import { ConsommationNAF } from '@/lib/postgres/models';
import * as biodiversite from '../databases/biodiversite';
import * as inconfortThermique from '../databases/inconfortThermique';
import { prisma } from '../db';

jest.setTimeout(60000); // Increase timeout for heavy queries
// PETR Figeac - Quercy - Vallée de la Dordogne 169 communes
// PNR FR8000035 73 communes

describe('Integration: query functions for biodiversite', () => {
  it('GetAgricultureBio returns expected results for EPCI 200054781', async () => {
    const result = await biodiversite.GetAgricultureBio(
      'Métropole du Grand Paris',
      'epci',
      '200054781'
    );
    expect(Array.isArray(result)).toBe(true);
    expect(result.length).toBe(5);
    expect(result[0]).toHaveProperty('LIBELLE_SOUS_CHAMP', 'Surface certifiée');
    // S'assurer qu'aucune colonne ne commence par un chiffre (bug entre prisma et postgres)
    expect(Object.keys(result[0]).every((key) => !/^\d/.test(key))).toBe(true);
  });
  it('GetConsommationNAF returns expected results for EPCI 200054781', async () => {
    const result = await biodiversite.GetConsommationNAF(
      '200054781',
      'Métropole du Grand Paris',
      'epci'
    );
    expect(Array.isArray(result)).toBe(true);
    expect(result.length).toBe(130);
    const uniqueDepartements = new Set(
      result.map((item: ConsommationNAF) => item.libelle_departement)
    );
    expect(uniqueDepartements.size).toBe(6);
    expect(
      result.every((item: ConsommationNAF) => item.naf09art23 !== null)
    ).toBe(true);
    // S'assurer qu'aucune colonne ne commence par un chiffre (bug entre prisma et postgres)
    expect(Object.keys(result[0]).every((key) => !/^\d/.test(key))).toBe(true);
  });
  it('GetAOT40 returns expected results', async () => {
    const result = await biodiversite.GetAOT40();
    expect(Array.isArray(result)).toBe(true);
    expect(result.length).toBe(291);
    expect(result[0]).toHaveProperty('valeur_brute', 9487.38664050025);
    // S'assurer qu'aucune colonne ne commence par un chiffre (bug entre prisma et postgres)
    expect(Object.keys(result[0]).every((key) => !/^\d/.test(key))).toBe(true);
  });
});

describe('Integration: query functions for inconfortThermique', () => {
  it('GetConfortThermique returns array', async () => {
    const result = await inconfortThermique.GetConfortThermique(
      '200070555',
      'Communauté de communes de la Veyle',
      'epci'
    );
    expect(Array.isArray(result)).toBe(true);
    expect(result.length).toBe(391);
    // S'assurer qu'aucune colonne ne commence par un chiffre (bug entre prisma et postgres)
    expect(Object.keys(result[0]).every((key) => !/^\d/.test(key))).toBe(true);
  });

  it('confort_thermique returns expected value for code_geographique 13055', async () => {
    const result = await prisma.$queryRaw<[{ valeur: number }]>`
      SELECT valeur
      FROM databases_v2.confort_thermique
      WHERE code_geographique = '13055'
    `;
    expect(result).toHaveLength(1);
    expect(result[0].valeur).toBe(0.08537360366198976);
  });

  it('confort_thermique returns expected value for code_geographique 75056', async () => {
    const result = await prisma.$queryRaw<[{ valeur: number }]>`
      SELECT valeur
      FROM databases_v2.confort_thermique
      WHERE code_geographique = '75056'
    `;
    expect(result).toHaveLength(1);
    expect(result[0].valeur).toBe(0.056940444530448095);
  });

  it('confort_thermique returns expected value for code_geographique 69123', async () => {
    const result = await prisma.$queryRaw<[{ valeur: number }]>`
      SELECT valeur
      FROM databases_v2.confort_thermique
      WHERE code_geographique = '69123'
    `;
    expect(result).toHaveLength(1);
    expect(result[0].valeur).toBe(0.06629419113240076);
  });
});

describe('Integration: query functions to check if collectivites_searchbar has right structure', () => {
  it('collectivites_searchbar table has expected checksum', async () => {
    const result = await prisma.$queryRaw<[{ checksum: string }]>`
      SELECT md5(string_agg(t::text, '')) AS checksum
      FROM (
        SELECT * FROM databases_v2.collectivites_searchbar ORDER BY index
      ) t;
    `;
    expect(result).toHaveLength(1);
    expect(result[0].checksum).toBe('4cbd76e64a8e932241ec1ea602a93c02');
  });
});


afterAll(async () => {
  await prisma.$disconnect();
});
